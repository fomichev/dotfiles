#!/bin/sh

[ $# -eq 0 ] && exit

args=
variant=""
pager="| less -r"
pattern=
grc=

[ -r ~/.grc ] && { grc="$(cat ~/.grc | tr '\n' ' ')"; }

while [ $# -gt 0 ]; do
	if [ "$(echo "$1" | sed -e 's/^-//')" = "$1" ]; then
		break
	else
		case $1 in
			--no-pager)
				pager=""
				;;

			--git)
				variant="git"
				;;
			--gnu)
				variant="gnu"
				;;
			*)
				args="$args $1"
				;;
		esac
		shift
	fi
done
pattern=$*

git_grep() {
	$(git rev-parse --show-toplevel &>/dev/null)
	[ ! $? -eq 0 ] && return

	opts=$(cat <<-END
		-n \
		-I \
		-E
		END)

	if [ -z "$pager" ]; then
		export GIT_PAGER=''
	else
		pager_opts="--color=always"
	fi

	exec git grep $opts $pager_opts $args "$pattern"
}

gnu_grep() {
	opts=$(cat <<-END
! -path '*.swp' \
! -path '*~' \
! -path '*.a' \
! -path '*.o' \
! -path '*/tags' \
! -path '*/ipkg-*' \
! -path '*/.deps' \
! -path '*/autom4te.cache' \
! -path '*/.git*' \
! -path '*/.hg*' \
! -path '*/.svn*'
END)

	if [ -z "$pager" ]; then
		pager_opts="--color=never"
	else
		pager_opts="--color=always"
	fi

	exec sh -c "find . -type f $opts $grc -print0 | xargs --null grep -nE $pager_opts '$pattern' $pager 2>/dev/null"
}

case $variant in
	git) git_grep ;;
	gnu) gnu_grep ;;
	*) git_grep; gnu_grep ;;
esac
