#!/bin/sh

curdir=$(cd $(dirname $0) && pwd)
version=`cat include/config/kernel.release`

if [ -e /boot/vmlinuz-$version ]; then
	$curdir/kremove
fi

if [ ! "x$1" = "x-m" ]; then
	echo "Install kernel ($version)..."
	sudo mkdir -p /lib/modules/$version
	sudo make install
	cp .config /boot/config-$version
fi

echo "Install modules..."
sudo make modules_install
if [ ! $? -eq 0 ]; then
	exit
fi

echo "Generate initramfs..."
if [ -e /sbin/mkinitrd ]; then
	sudo mkinitrd --force /boot/initramfs-$version.img $version
else
	sudo update-initramfs -c -k $version
fi

if [ ! $? -eq 0 ]; then
	exit
fi

echo "Update grub..."
if [ -e /sbin/grubby ]; then
	sudo grubby --add-kernel=/boot/vmlinux-$version \
		--title="Linux Kernel $version" \
		--initrd=/boot/initramfs-$version.img \
		--args="ro root=/dev/sda6"
else
	sudo update-grub
fi
