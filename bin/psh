#!/bin/bash

set -e

APP="$(basename $0)"
usage() { echo "usage: $APP [-S] [command]"; exit; }

set -- `getopt S $*`
[ ! $? -eq 0 ] && { exit 1; }

SUDO=0
LOCK=$(mktemp)

while [ ! "$1" = "--" ]; do
	case "$1" in
	-S)
		SUDO=1
		;;
	*)
		usage
		;;
	esac
	shift
done
shift

if [ $SUDO -eq 1 ]; then
	read -s -p pass: pass 1>&2
	echo 1>&2
fi

OPTS="-o StrictHostKeyChecking=no"
do_ssh() {
	if [ $SUDO -eq 1 ]; then
		echo $pass | (ssh $OPTS $HOST "sudo -p ' ' -S bash -c '$@'") 2>/dev/null
	else
		(ssh $OPTS $HOST "bash -c '$@'")
	fi
}

touch $LOCK

i=0
for HOST in $(cat ~/hosts); do
	i=$(($i + 1))
	(ret=$(do_ssh "$@") && flock $LOCK -c "bash -c 'echo -n \"${HOST}: \" | colorify && echo -e \"$ret\"'") &
	if [ $(($i % 10)) = 0 ]; then wait; fi
done
wait

rm $LOCK
