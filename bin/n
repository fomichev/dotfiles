#!/usr/bin/env ruby

$0 = 'n'

require 'optparse'

edit = true

OptionParser.new do |opts|
  opts.banner = 'Usage: n [options] [name]'

  opts.on('-l', '--list', 'List all notes') do |v|
    edit = false
  end
end.parse!

dirs = [ File.join(ENV['HOME'], 'Dropbox', 'notes'),
         File.join(ENV['HOME'], 'Yandex.Disk', 'notes'),
         File.join(ENV['HOME'], 'yadisk', 'notes'),
         File.join(ENV['HOME'], 'notes') ]

$root = dirs.detect { |d| Dir.exist?(d) }
abort "Notes directory is not found!" unless $root

ext = 'txt'

$files = Dir.glob(File.join($root, '**', '*.txt')).map do
  |p| [ File.basename(p).sub(/\.#{ext}$/, '').downcase, p ]
end

def command_edit(name)
  name = 'scratch' if name == ''
  file, = $files.select { |e| e[0] == name }

  unless file
    file = ['', File.join($root, "#{name}.txt") ]
  end

  system("$EDITOR '#{file[1]}'")
end

def command_list
  $files.each { |e| puts e[0] }
end

if edit
  command_edit(ARGV.join(' '))
else
  command_list
end
