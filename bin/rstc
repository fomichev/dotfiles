#!/bin/bash

export GOOGLE_PROJECT_ID=680984499942
export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gs-secret-restic-key.json
export RESTIC_PASSWORD_FILE="$HOME/restic-password.txt"

REPO=${REPO:-gs:$(hostname -s):/}
ARGS=${ARGS:- --limit-upload 512}

do_rstc() {
	echo sudo -E restic -r "$REPO" "$@"
	sudo -E restic -r "$REPO" "$@" 2>&1 | stdbuf -o0 cat
}

if [ $# -eq 0 ]; then
	do_rstc \
		--verbose \
		--verbose \
		$ARGS \
		--exclude-file $HOME/src/dotfiles/.restic-exclude \
		backup /

	do_rstc forget --keep-last 5 --prune
	do_rstc snapshots
	exit
fi

do_rstc "$@"
