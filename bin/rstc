#!/bin/bash

set -x
set -eo pipefail

source ~/.secret/restic-settings

SERVICE=restic.service

say() {
	echo ">> $@" | $HOME/bin/colorify
}

if [[ -z "$REPO" ]]; then
	say '$REPO is not specified!'
	exit 1
fi

failure() {
	do_notify "Backup finished with errors!"
	$HOME/bin/systemd-email s@fomichev.me $SERVICE "$(hostname) error"
}

do_rstc() {
	say restic -r "$REPO" "$@"
	sudo -E restic -r "$REPO" "$@" 2>&1 | cat
}

system_upgrade() {
	say 'update system'
	yes | sudo pacman -Syu
	say 'remove orphans'
	yes | sudo pacman -Rs $(pacman -Qqtd)
	say 'cleanup'
	sudo journalctl --vacuum-time=7d || :
	#if command -v flatpak &> /dev/null; then
	#	flatpak uninstall --unused || :
	#fi
	yes | sudo pacman -Scc || :

	$HOME/bin/systemd-email s@fomichev.me $SERVICE "$(hostname) update"
}

standard_notes() {
	local oldest_backup=$(ls -t ~/Downloads/Standard\ Notes\ Backup\ -\ S*.zip | head -n1)
	if [[ -z "$oldest_backup" ]]; then
		echo "Skipping notes backup!"
		return
	fi
	echo "Saving oldest notes backup: $oldest_backup"
	unzip -c "$oldest_backup" 'Standard Notes Backup and Import File.txt' | pass insert -mf notes
}

google_drive() {
	if [[ -d $HOME/Drive ]]; then
		say 'pull could data'
		DRY=n $HOME/bin/cloud pull
	fi
}

google_photos() {
	if [[ -d $HOME/Pictures/Google ]]; then
		say 'fetch google photos'
		$HOME/.local/bin/gphotos-sync ~/Pictures/Google/
	fi
}

is_running() {
	[[ $(systemctl --user is-active $SERVICE) == "active" ]]
}

tail_journal() {
	journalctl --user -fu $SERVICE
}

do_notify() {
	if command -v notify-send &> /dev/null; then
		notify-send "$@"
	elif command -v telegram-send &> /dev/null; then
		telegram-send "$@"
	fi
}

# Started without arguments.
if [[ $# -eq 0 ]]; then
	# Started manually via shell, start systemd service instead.
	if [[ -z "$INVOCATION_ID" ]]; then
		# Already running, tail journal.
		if is_running; then
			tail_journal
			exit
		fi

		systemctl --user start $SERVICE
		tail_journal
		exit
	fi

	# Otherwise, run default actions.
	trap failure EXIT

	do_notify "Starting backup"
	standard_notes
	google_drive
	google_photos

	do_rstc \
		--verbose \
		--verbose \
		$ARGS \
		--exclude-file $HOME/src/dotfiles/.restic-exclude \
		backup /

	do_rstc unlock

	do_rstc snapshots
	do_rstc forget --keep-within 95d --prune
	do_rstc stats
	$HOME/bin/systemd-email s@fomichev.me $SERVICE "$(hostname) backup"
	trap - EXIT

	system_upgrade
	do_notify "Backup finished successfully"
	exit
fi

do_rstc "$@"
