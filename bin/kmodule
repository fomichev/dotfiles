#!/bin/sh

curdir=$PWD
drvdir=$curdir/drivers

usage() {
	echo "usage: $(basename $0) <module> [ <module2> ... <moduleN> ]"

	exit 0
}

update_module() {
	local module=$1
	local moddir=$(find $drvdir -name $module* | head -n1)

	echo "Update module $module"

	if [ -z $moddir ]; then
		echo "Module directory not found"
		exit
	elif [ ! -d $moddir ]; then
		moddir=$(dirname $moddir)
	fi

	echo "Module $module directory is $moddir"

	echo "Building..."
	make SUBDIRS=$moddir

	if [ ! $? = 0 ]; then
		exit
	fi

	local modfile=$(find $drvdir -name $module.ko)

	if [ -z $modfile ]; then
		echo "Module object not found"
		exit
	fi

	echo "Module $module object is $modfile"/home/sdf/src/linux-next/drivers/input/mouse/bcm5974

	echo "Unloading..."
	sudo rmmod $module

	echo "Loading..."
	sudo insmod $modfile
}

if [ -z $* ] || [ $1 = "-h" ] || [ $1 = "--help" ]; then
	usage
fi

for mod in $*; do
	update_module $mod
done
